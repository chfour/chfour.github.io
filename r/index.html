<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>redirector</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div id="infoui">
        <h1>redirector</h1>
        <h2>usage</h2>
        <p>use <code>https://chfour.github.io/r/#id</code> where <code>id</code> is any from the following list of redirects</p>
        <h2>list</h2>
        <ul id="list">
            <li>loading list...</li>
            <li>tip: if you don't have javascript enabled, enable it now or browse <a href="redirects.json">redirects.json</a> manually</li>
        </ul>
    </div>
    <div id="redirui" style="display: none; margin: auto; width: max-content;">
        <p style="font-size: 2em;">redirecting in <span id="timeout">5</span>s...</p>
        <p><a href="#">stop</a></p>
    </div>
    <script>
        let redirectsFile, timeoutId;
        function getHash() {return decodeURIComponent(window.location.hash.slice(1))}
        function setMainVisible(ye) {
            document.getElementById("infoui" ).style.display =  ye ? "block" : "none";
            document.getElementById("redirui").style.display = !ye ? "block" : "none";
        }
        
        function tryRedirect() {
            const redirId = getHash();
            console.debug("hashchange", redirId);
            if(!(redirId in redirectsFile["redirects"])){
                if(timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }
                setMainVisible(true);
                return
            }
            const targetUrl = redirectsFile["redirects"][redirId];
            console.log("redirecting to " + redirId + " -> " + targetUrl);
            setMainVisible(false);
            document.getElementById("timeout").innerText = redirectsFile["delay"];

            if(timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
            timeoutId = setTimeout(() => {
                console.log("redirecting!");
                window.location.replace(targetUrl);
            }, redirectsFile["delay"] * 1000);
        }
        
        const redirectsList = document.getElementById("list");
        fetch("./redirects.json").then(data => data.json())
            .then(list => {
                while(redirectsList.firstChild) redirectsList.removeChild(redirectsList.lastChild);
                console.log(list);
                Object.entries(list["redirects"]).forEach(([k, v]) => {
                    const newLink = document.createElement("a");
                    newLink.innerText = k;
                    newLink.setAttribute("href", "#" + k);
                    newLink.style.fontFamily = "var(--font-monospace, monospace)"
                    
                    const targetUrl = document.createElement("span");
                    targetUrl.innerText = v;
                    targetUrl.style.fontFamily = "var(--font-monospace, monospace)";

                    const newItem = document.createElement("li");
                    newItem.appendChild(newLink);
                    newItem.appendChild(document.createTextNode(" \u2192 "));
                    newItem.appendChild(targetUrl);

                    redirectsList.appendChild(newItem);
                })
                
                return list
            })
            .then(list => {
                redirectsFile = list;
                tryRedirect();
                window.addEventListener("hashchange", tryRedirect);
            })
    </script>
</body>
</html>